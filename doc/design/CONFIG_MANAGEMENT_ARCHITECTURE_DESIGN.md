# 設定管理アーキテクチャ設計書

## 1. 概要

PostgreSQL Schema Diff Tool (PGSD)の設定管理システムのアーキテクチャ設計を定義する。階層的設定管理、環境変数置換、バリデーション機能を含む包括的な設定管理システムを提供する。

## 2. アーキテクチャ方針

### 2.1 設計原則
- **階層的設定管理**: 複数の設定ソースを優先度順で統合
- **型安全性**: 設定値の型チェックとバリデーション
- **セキュリティ**: 機密情報の適切な管理とマスキング
- **柔軟性**: 環境別設定の容易な切り替え
- **拡張性**: 新しい設定項目の追加が容易

### 2.2 設定階層（優先度順）
```
1. CLI引数        (最高優先度)
2. 環境変数
3. 設定ファイル
4. デフォルト値    (最低優先度)
```

## 3. アーキテクチャ設計

### 3.1 システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                     Configuration Manager                   │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ CLI Parser  │  │ Env Parser  │  │ File Parser (YAML)  │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│           │               │                    │            │
│           └───────────────┼────────────────────┘            │
│                           │                                 │
│  ┌─────────────────────────▼─────────────────────────────┐  │
│  │              Config Merger                           │  │
│  │            (Priority Resolution)                     │  │
│  └─────────────────────────┬─────────────────────────────┘  │
│                           │                                 │
│  ┌─────────────────────────▼─────────────────────────────┐  │
│  │              Config Validator                        │  │
│  │         (Schema & Business Rules)                    │  │
│  └─────────────────────────┬─────────────────────────────┘  │
│                           │                                 │
│  ┌─────────────────────────▼─────────────────────────────┐  │
│  │              Environment Substitutor                 │  │
│  │            (Variable Replacement)                    │  │
│  └─────────────────────────┬─────────────────────────────┘  │
│                           │                                 │
│  ┌─────────────────────────▼─────────────────────────────┐  │
│  │              Configuration Object                    │  │
│  │             (Typed Access Interface)                 │  │
│  └─────────────────────────┬─────────────────────────────┘  │
└─────────────────────────────┼─────────────────────────────────┘
                             │
            ┌────────────────▼────────────────┐
            │        Application Core         │
            │     (Database, Reports, etc)    │
            └─────────────────────────────────┘
```

### 3.2 コンポーネント設計

#### 3.2.1 ConfigurationManager
- **責務**: 設定管理の統合制御
- **機能**:
  - 複数ソースからの設定読み込み
  - 優先度に基づく設定マージ
  - 設定値の提供インターフェース

#### 3.2.2 ConfigurationSchema
- **責務**: 設定項目の定義とスキーマ管理
- **機能**:
  - 設定項目の型定義
  - デフォルト値の管理
  - 設定グループの構造化

#### 3.2.3 ConfigurationValidator
- **責務**: 設定値の検証
- **機能**:
  - 型チェック
  - 値の範囲チェック
  - 依存関係の検証
  - カスタムビジネスルール

#### 3.2.4 EnvironmentSubstitutor
- **責務**: 環境変数の置換処理
- **機能**:
  - `${VAR_NAME}` 形式の変数置換
  - .envファイルの読み込み
  - 未定義変数のエラーハンドリング

#### 3.2.5 ConfigurationParsers
- **CLIParser**: コマンドライン引数の解析
- **EnvParser**: 環境変数の解析
- **FileParser**: YAML設定ファイルの解析

## 4. 設定スキーマ設計

### 4.1 設定カテゴリ

```python
@dataclass
class DatabaseConfig:
    host: str
    port: int
    database: str
    username: str
    password: str
    schema: str
    connection_timeout: int
    ssl_mode: str

@dataclass
class OutputConfig:
    format: str
    path: str
    filename_template: str
    include_timestamp: bool

@dataclass
class ComparisonConfig:
    include_views: bool
    include_constraints: bool
    ignore_case: bool
    exclude_tables: List[str]
    exclude_columns: List[str]

@dataclass
class SystemConfig:
    timezone: str
    log_level: str
    log_file: str
    max_connections: int
    temp_directory: str

@dataclass
class PostgreSQLConfig:
    minimum_version: str
    version_check: bool
    compatibility_mode: str

@dataclass
class PGSDConfiguration:
    source_db: DatabaseConfig
    target_db: DatabaseConfig
    output: OutputConfig
    comparison: ComparisonConfig
    system: SystemConfig
    postgresql: PostgreSQLConfig
```

### 4.2 セキュリティ設計

#### 4.2.1 機密情報の管理
- **パスワードマスキング**: ログ出力時の自動マスキング
- **環境変数推奨**: 機密情報は環境変数での設定を推奨
- **設定ファイル暗号化**: 将来的な暗号化サポート

#### 4.2.2 設定ファイル検索順序
```
1. CLI指定パス
2. ./pgsd_config.yaml
3. ~/.pgsd/config.yaml
4. /etc/pgsd/config.yaml
```

## 5. エラーハンドリング設計

### 5.1 設定エラーの分類
- **ConfigurationError**: 設定関連の基底エラー
- **InvalidConfigurationError**: 無効な設定値
- **MissingConfigurationError**: 必須設定の欠落
- **ConfigurationFileError**: 設定ファイルの読み込みエラー

### 5.2 エラー復旧戦略
- **部分設定**: 一部設定エラーでもデフォルト値で継続
- **設定診断**: 設定問題の詳細診断機能
- **設定例生成**: 正しい設定例の自動生成

## 6. パフォーマンス設計

### 6.1 設定読み込み最適化
- **遅延読み込み**: 必要時のみ設定ファイル読み込み
- **設定キャッシュ**: 一度読み込んだ設定のメモリキャッシュ
- **増分更新**: 設定変更時の部分更新

### 6.2 メモリ効率
- **設定共有**: 複数コンポーネント間での設定オブジェクト共有
- **軽量設計**: 不要な設定データの除外

## 7. 統合設計

### 7.1 エラーハンドリングとの統合
- PGSD-013で実装したカスタム例外との連携
- 設定エラー時の適切な終了コード設定
- エラーコンテキストでの設定情報提供

### 7.2 ロギングとの統合
- PGSD-012で実装したロギング機能との連携
- 設定読み込み過程のログ出力
- 機密情報のマスキング

## 8. テスト戦略

### 8.1 単体テスト
- 各パーサーの動作テスト
- バリデーションルールのテスト
- 環境変数置換のテスト

### 8.2 統合テスト
- 設定階層の統合テスト
- 実際の設定ファイルでの動作テスト
- エラーシナリオのテスト

### 8.3 セキュリティテスト
- 機密情報漏洩のテスト
- 設定ファイル権限のテスト
- 無効な設定での動作テスト

## 9. 将来拡張

### 9.1 設定管理の拡張
- **設定バージョニング**: 設定スキーマのバージョン管理
- **設定移行**: 古い設定形式からの自動移行
- **設定テンプレート**: 環境別設定テンプレート

### 9.2 セキュリティ拡張
- **設定ファイル暗号化**: AES暗号化サポート
- **権限管理**: ユーザー別設定アクセス制御
- **監査ログ**: 設定変更の監査ログ

## 10. 実装優先度

### Phase 1 (必須機能)
1. 基本設定管理クラス
2. YAML設定ファイル読み込み
3. 環境変数置換
4. 基本バリデーション

### Phase 2 (重要機能)
1. CLI統合
2. 設定階層管理
3. エラーハンドリング統合
4. セキュリティ機能

### Phase 3 (拡張機能)
1. 設定診断機能
2. パフォーマンス最適化
3. 将来拡張対応

---

このアーキテクチャ設計に基づいて、PGSD-014の実装を進める。