# PGSD-019: 差分検出エンジン実装

## チケット情報
- **ID**: PGSD-019
- **タイトル**: 差分検出エンジン実装
- **トラッカー**: 機能
- **優先度**: High
- **ステータス**: TODO
- **担当者**: 未定
- **見積（時間）**: 5時間
- **実績（時間）**: -
- **依存チケット**: PGSD-018（データモデル）、PGSD-017（スキーマ情報取得）
- **ブロックチケット**: PGSD-020（コアエンジン統合）

## 概要
PGSD-007で検証した集合演算ベースのアルゴリズムを実装し、2つのスキーマ間の差分を効率的に検出するエンジンを開発する。

## 背景・理由
- プロジェクトの核となる機能
- 高性能な差分検出の実現
- 拡張可能な差分検出アーキテクチャ
- 検証済みアルゴリズムの実装

## 詳細要件
### 差分検出機能
```python
class DiffAnalyzer:
    def analyze(self, schema_a: SchemaInfo, schema_b: SchemaInfo) -> DiffResult:
        # 集合演算ベースの差分検出
        pass
    
    def _compare_tables(self, tables_a, tables_b):
        # テーブル差分検出
        pass
    
    def _compare_columns(self, columns_a, columns_b):
        # カラム差分検出  
        pass
    
    def _compare_constraints(self, constraints_a, constraints_b):
        # 制約差分検出
        pass
    
    def _compare_views(self, views_a, views_b):
        # ビュー差分検出
        pass
```

### 差分検出アルゴリズム
1. **テーブル差分**
   - 追加されたテーブル
   - 削除されたテーブル
   - 名前変更されたテーブル（推定）

2. **カラム差分**
   - 追加されたカラム
   - 削除されたカラム
   - 変更されたカラム（データ型、NULL制約、デフォルト値）

3. **制約差分**
   - 主キー、外部キー、UNIQUE、CHECK制約
   - 制約の追加・削除・変更

4. **ビュー差分**
   - ビューの追加・削除・定義変更

### パフォーマンス要件
- 時間計算量: O(テーブル数 × カラム数)
- 中規模スキーマ（100テーブル）: <10秒
- 大規模スキーマ（1000テーブル）: <60秒

## 受入条件
- [ ] テーブルの追加・削除・変更を検出できる
- [ ] カラムの追加・削除・変更を検出できる
- [ ] 制約の追加・削除・変更を検出できる
- [ ] ビューの追加・削除・変更を検出できる
- [ ] 差分結果が構造化データで返される
- [ ] パフォーマンス要件を満たす

## テスト項目
### 単体テスト
- [ ] 各差分検出機能の個別テスト
- [ ] エッジケース（空スキーマ、同一スキーマ）の処理
- [ ] 大文字小文字の処理
- [ ] NULL値の処理

### 統合テスト
- [ ] PGSD-007のサンプルスキーマでの検証
- [ ] 複雑なスキーマでの差分検出
- [ ] パフォーマンステスト

### 受入テスト
- [ ] 実際のデータベーススキーマでの動作確認
- [ ] 差分結果の精度確認
- [ ] メモリ使用量の確認

## 実装検証項目
### セルフレビューチェックリスト
- [ ] アルゴリズムがPGSD-007の設計通り実装されている
- [ ] コードが効率的で保守性が高い
- [ ] エラーハンドリングが適切である
- [ ] メモリ使用量が最適化されている
- [ ] ログ出力が適切である
- [ ] 型安全性が確保されている
- [ ] テストカバレッジが85%以上
- [ ] ドキュメントにアルゴリズム説明が記載されている

### 静的解析
- [ ] 計算量の複雑性確認
- [ ] メモリリークの検出
- [ ] 型チェック完全通過

## TODO
### 設計フェーズ
- [ ] PGSD-007アルゴリズムの詳細実装設計
- [ ] データ構造の最適化設計
- [ ] エラーハンドリング設計

### 実装フェーズ
- [ ] analyzer.py実装
- [ ] 差分検出アルゴリズム実装
- [ ] パフォーマンス最適化
- [ ] 包括的テストコード作成

### 検証フェーズ
- [ ] アルゴリズム精度テスト
- [ ] パフォーマンステスト
- [ ] メモリプロファイリング

## 作業メモ
- PGSD-007の検証結果を参考に実装
- 集合演算の効率的な実装
- 将来のPostgreSQL固有機能対応の考慮

## 作業記録
- **開始日時**: 未定
- **完了日時**: 未定
- **実績時間**: 未定
- **見積との差異**: 未定
- **差異の理由**: 未定

## 技術検討事項
- [ ] setベース vs dictベース実装
- [ ] 並列処理の適用可能性
- [ ] キャッシュ戦略
- [ ] 差分結果の最適な表現形式

---

作成日: 2025-07-12