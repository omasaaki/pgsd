# PGSD-045: 新規テーブルのカラムを個別のカラム追加として計上しない修正

## 📋 基本情報

- **チケット番号**: PGSD-045
- **タイトル**: 新規テーブルのカラムを個別のカラム追加として計上しない修正
- **種別**: バグ修正 (Bug Fix)
- **優先度**: High
- **作成日**: 2025-07-19
- **担当者**: システム開発チーム
- **推定工数**: 2時間
- **ステータス**: IN_PROGRESS

## 🐛 バグ詳細

### 現象
スキーマ比較レポートにおいて、新規追加されたテーブルのカラムが「カラム追加」として個別にカウントされている。
例：4つのテーブルが追加され、それらに合計500カラムある場合、「カラム追加: 500」と表示される。

### 期待される動作
- 新規テーブルに含まれるカラムは、個別のカラム変更としてカウントしない
- 既存テーブルへのカラム追加のみをカラム変更としてカウントする
- 削除されたテーブルのカラムも同様に扱う

### 影響
- サマリー統計の「Column Changes」が実際の変更内容と乖離
- ユーザーが実際の変更規模を正しく把握できない

## 🔍 原因分析

`src/pgsd/core/analyzer.py`の`_compare_tables`メソッド（271-312行目）において：

1. 新規テーブル追加時（280-293行目）：
   ```python
   # Add all columns as added
   for column in tables_b[table_name].columns:
       self.result.columns["added"].append(
           {"table": table_name, "column": column}
       )
   ```

2. テーブル削除時（298-302行目）：
   同様に削除テーブルの全カラムを「removed」に追加

この実装により、テーブルレベルの変更とカラムレベルの変更が区別されていない。

## 🔧 修正方針

### オプション1: カラムリストへの追加を条件付きにする
- 新規/削除テーブルのカラムは`columns["added"]`/`columns["removed"]`に追加しない
- 既存テーブルの変更のみを記録

### オプション2: カラム変更にメタデータを追加
- カラム変更に`is_table_level_change`フラグを追加
- レポート生成時にフラグを考慮してフィルタリング

### オプション3: 別々のリストで管理
- `table_level_column_changes`と`column_level_changes`を分離
- サマリー計算時は`column_level_changes`のみをカウント

推奨: オプション1（シンプルで既存コードへの影響が最小）

## 📝 実装タスク

- [ ] `_compare_tables`メソッドの修正
  - [ ] 新規テーブル処理部分の修正（カラム追加をスキップ）
  - [ ] 削除テーブル処理部分の修正（カラム削除をスキップ）
- [ ] サマリー統計の確認
- [ ] 既存テストケースの修正
- [ ] 新規テストケースの追加

## 🧪 テスト計画

### 1. 単体テスト
- 新規テーブル追加時のカラムカウント確認
- テーブル削除時のカラムカウント確認
- 既存テーブルへのカラム追加が正しくカウントされることを確認

### 2. 統合テスト
- 実際のスキーマ比較でサマリー統計が正確であることを確認
- レポート出力の確認

### 3. 回帰テスト
- 既存の機能に影響がないことを確認

## 🎯 受入条件

1. **正確なカウント**
   - 新規テーブルのカラムが個別のカラム追加としてカウントされない
   - 削除テーブルのカラムが個別のカラム削除としてカウントされない
   - 既存テーブルへの変更のみがカラム変更としてカウントされる

2. **レポート表示**
   - サマリーの「Column Changes」が実際の変更を反映
   - 詳細表示は現状維持（どのテーブルにどんな変更があったかは表示）

3. **互換性**
   - 既存のAPIインターフェースに変更なし
   - 既存のレポート形式を維持

## 📚 関連情報

### 影響を受けるファイル
- `src/pgsd/core/analyzer.py`: スキーマ比較ロジック
- `tests/unit/core/test_analyzer.py`: アナライザーのテスト

### 関連チケット
- PGSD-044: HTMLレポートに詳細な変更内容を表示する機能の実装（完了）

### 現在の実装例
```python
# 現在の問題のあるコード
if table_name not in tables_a:
    # Table added
    self.result.tables["added"].append(tables_b[table_name])
    # Add all columns as added（これが問題）
    for column in tables_b[table_name].columns:
        self.result.columns["added"].append(
            {"table": table_name, "column": column}
        )
```

## 📝 作業記録

- **開始日時**: 2025-07-19
- **完了日時**: 未完了
- **実績時間**: 未記録
- **見積との差異**: 未記録

## 🔄 進捗ステップ

### Step 1: 分析と設計（30分）
- [ ] 現在の実装の詳細分析
- [ ] 修正による影響範囲の確認
- [ ] 実装方針の最終決定

### Step 2: 実装（1時間）
- [ ] `_compare_tables`メソッドの修正
- [ ] 関連するヘルパーメソッドの確認と修正
- [ ] コメントとドキュメントの更新

### Step 3: テストと検証（30分）
- [ ] 既存テストの修正
- [ ] 新規テストケースの追加
- [ ] 実データでの動作確認

---
**チケット作成者**: Claude Assistant  
**最終更新**: 2025-07-19